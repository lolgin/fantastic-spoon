<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Комплексный тест по электробезопасности — offline/online</title>
<style>
/* Минимальные стили — аккуратно и компактно */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Segoe UI",Tahoma,Arial;background:linear-gradient(135deg,#667eea,#764ba2);color:#222;padding:16px}
.container{max-width:1100px;margin:0 auto}
.header{background:rgba(255,255,255,0.08);padding:16px;border-radius:12px;color:#fff;margin-bottom:12px;text-align:center}
.header h1{font-size:1.4rem;margin-bottom:6px}
.card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 14px 30px rgba(0,0,0,0.08);margin-bottom:12px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1}
.controls{display:flex;gap:8px;align-items:center}
.category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
.category-item{padding:10px;border-radius:10px;border:2px solid #e6eefc;background:#f8fbff;display:flex;justify-content:space-between;align-items:center}
.start-btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:10px 16px;border-radius:18px;border:none;cursor:pointer;font-weight:700}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.btn-secondary{background:#6b7280;color:#fff}
.btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.small{font-size:.9rem;color:#475569}
.hidden{display:none}
.progress{height:10px;background:#eef2ff;border-radius:8px;overflow:hidden;margin-top:10px}
.progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0;transition:width .4s}
.question-box{background:#f8fafc;padding:14px;border-radius:10px;border-left:6px solid #667eea;margin-top:12px}
.question{font-weight:700;margin-bottom:12px}
.options{display:grid;gap:10px}
.option{padding:10px;border-radius:8px;border:2px solid #e6eef0;background:#fff;cursor:pointer}
.option:hover:not(.disabled){transform:translateX(6px);border-color:#667eea}
.option.correct{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-color:#10b981}
.option.incorrect{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border-color:#ef4444}
.option.disabled{opacity:.8;cursor:not-allowed}
textarea{width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid #e2e8f0;margin-top:8px}
.export-area{width:100%;height:140px;padding:8px;border-radius:8px;border:1px dashed #e2e8f0;overflow:auto;background:#fbfdff;margin-top:8px}
.footer{font-size:.85rem;color:#fff;text-align:center;margin-top:10px}
@media(max-width:900px){ .row{flex-direction:column} .category-grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Комплексный тест по электробезопасности (offline / online)</h1>
    <div class="small">Работает с локальной базой при запуске через file:// и с Google Sheets / Apps Script при запуске через http(s).</div>
  </div>

  <!-- Настройки / интеграция -->
  <div class="card" id="setupCard">
    <div class="row">
      <div class="col">
        <div class="small">Spreadsheet ID (для чтения/записи через Apps Script)</div>
        <input type="text" id="spreadsheetId" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0;margin-top:6px" value="1MHo4Bg942KP_E6CVrzAA8LSPcdI8fFieH1El9W8h640">
        <div class="small" style="margin-top:8px">Публичная CSV ссылка (резерв, для чтения):</div>
        <input type="text" id="publicCsv" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0;margin-top:6px" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRP_Ypwcp2PxuRgYqYSN9CFIJqsZDM8g8N6xMYcuEdqACRAlNi5cAlF_9bu3yEcSS-fTKUn-lLZJ61t/pub?output=csv">
        <div class="small" style="margin-top:8px">Apps Script Web App URL (для записи обратно):</div>
        <input type="text" id="appsScriptUrl" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0;margin-top:6px" placeholder="https://script.google.com/macros/s/.../exec">
        <div class="small" style="margin-top:8px">Режим работы: <span id="modeLabel">определяется...</span></div>
      </div>

      <div style="width:340px">
        <div class="small">Параметры теста</div>
        <div style="margin-top:8px" class="controls">
          <label class="small">Кол-во:
            <select id="questionCount" style="margin-left:6px;padding:6px;border-radius:6px">
              <option>10</option><option selected>20</option><option>30</option><option>50</option>
            </select>
          </label>
          <label class="small">Ошибки:
            <select id="failureLimit" style="margin-left:6px;padding:6px;border-radius:6px">
              <option>2</option><option selected>3</option><option>5</option><option>999">Без ограничений</option>
            </select>
          </label>
        </div>

        <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
          <button class="start-btn" id="startBtn">Начать тест</button>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn btn-primary" id="loadPublicCsvBtn">Загрузить CSV (публично)</button>
            <button class="btn btn-success" id="saveToAppsBtn">Сохранить через Apps Script</button>
            <button class="btn btn-secondary" id="exportCsvBtn">Экспорт CSV</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn btn-secondary" id="openAdminBtn">Открыть админку</button>
            <button class="btn btn-danger" id="clearLocalBtn">Сброс localStorage</button>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px" class="small">Подсказка: если работаешь с локального диска (file://) — обязательно используем локальную базу (offline). Для записи в Google Sheets опубликуй Apps Script как веб-приложение и вставь URL.</div>
  </div>

  <!-- Админка -->
  <div class="card hidden" id="adminCard">
    <div class="row">
      <div class="col">
        <h3>Категории</h3>
        <div class="category-grid" id="categoryGrid"></div>

        <h3 style="margin-top:12px">Импорт / Экспорт</h3>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn btn-success" id="generateCsvBtn">Сгенерировать CSV</button>
          <button class="btn btn-secondary" id="downloadCsvBtn">Скачать CSV</button>
        </div>
        <textarea id="csvArea" placeholder="CSV (category,question,options|options|...,correct)"></textarea>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn btn-primary" id="importCsvBtn">Импорт (заменить)</button>
          <button class="btn btn-secondary" id="mergeCsvBtn">Импорт (добавить)</button>
        </div>
      </div>

      <div style="width:360px">
        <h3>Редактор вопросов</h3>
        <div>Категория: <strong id="currentCatName">—</strong></div>
        <input type="hidden" id="currentCatKey">
        <textarea id="questionInput" placeholder="Текст вопроса"></textarea>
        <input id="optionA" placeholder="a) Вариант A" style="width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e2e8f0">
        <input id="optionB" placeholder="b) Вариант B" style="width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e2e8f0">
        <input id="optionC" placeholder="c) Вариант C" style="width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e2e8f0">
        <input id="optionD" placeholder="d) Вариант D" style="width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e2e8f0">
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <label>Правильный:
            <select id="correctSelect"><option value="a">a</option><option value="b">b</option><option value="c">c</option><option value="d">d</option></select>
          </label>
          <button class="btn btn-success" id="saveQuestionBtn">Сохранить</button>
          <button class="btn btn-secondary" id="cancelEditBtn">Отмена</button>
          <button class="btn btn-danger" id="deleteQuestionBtn">Удалить</button>
        </div>

        <h3 style="margin-top:12px">Создать категорию</h3>
        <input id="newCatKey" placeholder="ключ_latin" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0">
        <input id="newCatName" placeholder="Название категории" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0;margin-top:6px">
        <button class="btn btn-primary" id="createCatBtn" style="margin-top:6px">Создать</button>
      </div>
    </div>
  </div>

  <!-- Тест -->
  <div class="card hidden" id="quizCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="questionProgress">Вопрос 1 из 20</div>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="small">✓ <span id="correctCount">0</span></div>
        <div class="small">✗ <span id="incorrectCount">0</span></div>
      </div>
    </div>
    <div class="progress"><div id="progressFill" class="progress-fill"></div></div>

    <div class="question-box">
      <div class="question" id="questionText">Вопрос...</div>
      <div class="options" id="optionsContainer"></div>
    </div>

    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
      <button class="btn btn-primary" id="nextBtn" disabled>Следующий →</button>
      <button class="btn btn-secondary" id="quitBtn">Выйти</button>
    </div>
  </div>

  <!-- Результаты -->
  <div class="card hidden" id="resultCard">
    <div style="text-align:center">
      <h2 id="resultTitle">Результаты</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px">
        <div class="card" style="background:#f8fbff;padding:10px;border-radius:8px"><div class="small">Результат</div><div id="finalScore" style="font-weight:800;font-size:1.3rem">0%</div></div>
        <div class="card" style="background:#f8fbff;padding:10px;border-radius:8px"><div class="small">Правильно</div><div id="finalCorrect" style="font-weight:800;font-size:1.3rem">0</div></div>
        <div class="card" style="background:#f8fbff;padding:10px;border-radius:8px"><div class="small">Неправильно</div><div id="finalIncorrect" style="font-weight:800;font-size:1.3rem">0</div></div>
        <div class="card" style="background:#f8fbff;padding:10px;border-radius:8px"><div class="small">Всего</div><div id="finalTotal" style="font-weight:800;font-size:1.3rem">0</div></div>
      </div>
      <div style="margin-top:12px">
        <button class="btn btn-success" id="restartBtn">🔄 Начать заново</button>
        <button class="btn btn-secondary" id="backSetupBtn">⚙️ Настройки</button>
      </div>
    </div>
  </div>

  <div class="footer">Файл двухрежимный — offline (file://) и online (http/https). Для помощи по Apps Script напиши «помоги с Apps Script».</div>
</div>

<script>
/* ===========================
   Конфигурация / состояние
   =========================== */
const CSV_OPTIONS_SEP = '|';
let questionBank = {};     // {cat: [{question, options:[], correct}]}
let categoryNames = {};    // {cat: "Название"}
let currentQuestions = [], currentIndex = 0, totalQuestions = 0, correctCount = 0, incorrectCount = 0;
let failureLimit = 3, editIndex = null, editingCat = null;

/* ===========================
   Локальная встроенная база (120 вопросов = 12 * 10)
   =========================== */
const defaultCategoryNames = {
  org: "Организационные меры",
  tech: "Технические меры",
  access: "Допуск и квалификация",
  vl: "Работы на ВЛ",
  special: "Взрывоопасные зоны",
  maintenance: "Техобслуживание",
  naryad: "Нарядно-допускная система",
  safety: "Общие требования и СИЗ",
  grounding: "Заземление и защитные меры",
  tools: "Инструменты и оборудование",
  dispatcher: "Диспетчеризация/оперативность",
  firstaid: "Первая помощь"
};

const defaultQuestionBank = {
  org: [
    {question:"Кто несет общую ответственность за организацию безопасных работ?", options:["Руководитель организации","Производитель работ","Выдающий наряд","Рабочие"], correct:"a"},
    {question:"Что обязательно должно быть перед началом работ?", options:["Наряд-допуск и инструктаж","Только письменное согласование","Только устное поручение","Ничего"], correct:"a"},
    {question:"Кто назначает ответственных за безопасное проведение работ?", options:["Руководитель работ","Бригада","Выдающий наряд","Диспетчер"], correct:"a"},
    {question:"Какой документ регламентирует порядок работ на электроустановках?", options:["Наряд-допуск","Устное распоряжение","Чек-лист","Сертификат"], correct:"a"},
    {question:"Можно ли привлекать к работам неаттестованный персонал?", options:["Нет","Да, под наблюдением","Только в неопасных работах","Только с разрешения начальства"], correct:"a"},
    {question:"Что такое целевой инструктаж?", options:["Краткая инструкция по конкретной работе","Полный курс обучения","Только проверка документов","Отчет о работе"], correct:"a"},
    {question:"Кто проверяет наличие средств индивидуальной защиты?", options:["Допускающий/производитель работ","Сам работник","Инспектор раз в год","Никакой"], correct:"a"},
    {question:"Как оформляется окончание работ по наряду?", options:["Записью о закрытии и подписями","Устно","По телефону","Без оформления"], correct:"a"},
    {question:"Кто может отменить наряд при обнаружении опасности?", options:["Выдающий наряд или допускающий","Только руководитель организации","Никто","Рабочие"], correct:"a"},
    {question:"Как часто пересматриваются инструкции по безопасности?", options:["По мере необходимости и после изменений правил","Каждые 10 лет","Никогда","Только при происшествии"], correct:"a"}
  ],
  tech: [
    {question:"Что следует сделать в первую очередь перед началом работ на электрооборудовании?", options:["Отключить питание и убедиться в отсутствии напряжения","Начать работу сразу","Проверить инструменты только","Позвонить руководителю"], correct:"a"},
    {question:"Как проверяют отсутствие напряжения?", options:["Измерителем/указателем напряжения","Визуально","По журналу","По опыту коллег"], correct:"a"},
    {question:"Что такое переносное заземление?", options:["Средство защиты от случайного появления напряжения","Постоянное заземление","Тестовый прибор","Изоляционная лента"], correct:"a"},
    {question:"Какие плакаты вывешивают при работах?", options:["«Не включать! Работают люди» и «Заземлено»","Только информационные","Никакие","Только указатели"], correct:"a"},
    {question:"Какая последовательность работ при отключении оборудования?", options:["Отключение, блокировка, заземление, проверка отсутствия напряжения","Сначала заземление, затем отключение","Сначала проверка, потом отключение","Произвольная"], correct:"a"},
    {question:"Что такое блокировки (lockout)?", options:["Физическая защита от случайного включения","Инструкция","Только плакат","Знак"], correct:"a"},
    {question:"Когда применяют изолирующие платформы и коврики?", options:["При работах в помещениях с токоведущими частями","Только для красоты","Не применяют","Только вне помещения"], correct:"a"},
    {question:"Какие приборы используют для проверки изоляции?", options:["Мегомметры и приборы измерения сопротивления","Только мультиметр","Никакие","Визуальный осмотр"], correct:"a"},
    {question:"Что должно быть на каждом отключенном устройстве?", options:["Плакат и средства блокировки","Только обмотка","Ничего","Только запись в журнале"], correct:"a"},
    {question:"Кто проводит осмотр электрооборудования перед пуском?", options:["Ответственные специалисты и производитель работ","Любой работник","Только инженер","Только подрядчик"], correct:"a"}
  ],
  access: [
    {question:"Что подтверждает право работника выполнять работы на электроустановках?", options:["Удостоверение/группа по электробезопасности","Наличие трудовой книжки","Возраст","Опыт"], correct:"a"},
    {question:"Какая минимальная группа допуска для самостоятельной работы до 1000 В?", options:["III","I","II","IV"], correct:"a"},
    {question:"Кто выдает допуск/наряд бригаде?", options:["Допускающий, имеющий право и группу","Любой рабочий","Диспетчер","Инспектор"], correct:"a"},
    {question:"Что проверяет допускающий перед выдачей наряда?", options:["Наличие удостоверений, СИЗ, инструментов, условий безопасности","Только удостоверения","Только инструменты","Ничего"], correct:"a"},
    {question:"Можно ли допустить работника без проверок?", options:["Нет","Да","Только в экстренных случаях","Только с разрешения врача"], correct:"a"},
    {question:"Как оформляется допуск работникам?", options:["Письменно: нарядом-допуском или распоряжением","Устно","Только в журнале","Без оформления"], correct:"a"},
    {question:"Кто отвечает за правильность оформления допуска?", options:["Производитель работ и допускающий","Бригада","Выдающий наряд","Диспетчер"], correct:"a"},
    {question:"Какова роль инструктажа перед выдачей допуска?", options:["Объяснить меры безопасности, последовательность работ и ответственность","Только формальность","Только тест","Не нужен"], correct:"a"},
    {question:"Какие документы необходимо иметь при выполнении работ?", options:["Наряд-допуск, удостоверения, инструкции","Только удостоверения","Ничего","Только договор"], correct:"a"},
    {question:"Можно ли допускать стажера без сопровождения?", options:["Только с сопровождением и под наблюдением","Да, всегда","Нет, никогда","Только если знаком с местом"], correct:"a"}
  ],
  vl: [
    {question:"Какие меры обязательны при работах на воздушных линиях (ВЛ)?", options:["Отключение, проверка, заземление, страховка и СИЗ","Только страховка","Только инструменты","Никакие"], correct:"a"},
    {question:"Какие СИЗ обязательны для работ на ВЛ?", options:["Изолирующие перчатки, страховочные пояса, каски","Только каска","Только перчатки","Только обувь"], correct:"a"},
    {question:"Что такое наведенное напряжение на ВЛ?", options:["Напряжение, возникающее индуктивно/емкостно на оборудовании рядом с линией","Никакое","Постоянное напряжение","Только в трансформаторе"], correct:"a"},
    {question:"Как проверяют отсутствие напряжения на проводах?", options:["Специальными указателями и измерителями","Визуально","Только по документам","Нельзя проверить"], correct:"a"},
    {question:"Можно ли работать в пролете пересечения ВЛ без мер безопасности?", options:["Нет, только после отключения и мер защиты","Да","Только днем","Только при опыте"], correct:"a"},
    {question:"Какие требования к подъему на опоры?", options:["Страховочные пояса и обучение","Любой способ","Только лестница","Без требований"], correct:"a"},
    {question:"Какие инструменты применяют на ВЛ?", options:["Изолированные и сертифицированные инструменты","Обычные","Все подряд","Без инструментов"], correct:"a"},
    {question:"Что делать при ухудшении погоды (гроза) во время работ на ВЛ?", options:["Прекратить работы и уйти в безопасное место","Продолжать","Ускориться","Сменить бригаду"], correct:"a"},
    {question:"Кто имеет право управлять работами на ВЛ?", options:["Производитель работ и допускающий","Любой рабочий","Инспектор раз в год","Диспетчер"], correct:"a"},
    {question:"Как оценивают состояние проводов перед работами?", options:["Визуально и инструментально по регламенту","Только визуально","Не оценивают","По опыту"], correct:"a"}
  ],
  special: [
    {question:"Какие меры обязательны в взрывоопасных зонах?", options:["Искробезопасное оборудование, газоанализ, вентиляция, СИЗ","Ничего","Только маски","Только ограждения"], correct:"a"},
    {question:"Что запрещено в ЭЗС?", options:["Курение, открытый огонь, искрообразующие работы","Только курить","Только сварку","Ничего"], correct:"a"},
    {question:"Какие приборы применяют для контроля газовой среды?", options:["Газоанализаторы и системы сигнализации","Термометры","Только визуально","Никакие"], correct:"a"},
    {question:"Кто допускается к работам в ЭЗС?", options:["Только подготовленные, аттестованные работники","Любой","Только диспетчер","Только инженер"], correct:"a"},
    {question:"Какие инструменты разрешены в ЭЗС?", options:["Искробезопасные сертифицированные","Обычные металлические","Пластиковые","Без требований"], correct:"a"},
    {question:"Что делать при превышении концентрации газа?", options:["Прекратить работы, эвакуировать, проветрить и измерить","Продолжать","Увеличить вентиляцию без мер","Ничего"], correct:"a"},
    {question:"Какие документы обязательны при работах в ЭЗС?", options:["Инструкции, акты замеров и наряды","Только наряд","Только сертификаты","Никакие"], correct:"a"},
    {question:"Кто контролирует безопасное состояние в ЭЗС?", options:["Ответственные лица и газовая служба","Любой","Только диспетчер","Только подрядчик"], correct:"a"},
    {question:"Можно ли использовать обычный электроинструмент в ЭЗС?", options:["Нет, только искробезопасный","Да","Только при малой мощности","Только с разрешения"], correct:"a"},
    {question:"Как действовать при утечке газа?", options:["Эвакуировать, отключить источники, вызвать спецслужбы","Игнорировать","Проветривать без эвакуации","Убирать оборудование"], correct:"a"}
  ],
  maintenance: [
    {question:"Что включает техническое обслуживание электрооборудования?", options:["Проверки, измерения, испытания и ремонт","Только визуальный осмотр","Только замену деталей","Ничего"], correct:"a"},
    {question:"Какие измерения выполняют при ТО?", options:["Сопротивление изоляции, сопротивление заземления, токи утечки","Только напряжение","Только ток","Не измеряют"], correct:"a"},
    {question:"Как оформляют результаты ТО?", options:["В актах, протоколах и журналах","Устно","Только в памяти","Не оформляют"], correct:"a"},
    {question:"Кто утверждает график ТО?", options:["Ответственный за электрохозяйство","Любой рабочий","Только инженер","Только подрядчик"], correct:"a"},
    {question:"Какие проверки перед вводом после ремонта?", options:["Испытания, измерения, проверка заземления","Визуально","Только запуск","Ничего"], correct:"a"},
    {question:"Как часто проверяют защитные средства?", options:["По регламенту и инструкциям","Никогда","Только при покупке","Ежедневно"], correct:"a"},
    {question:"Какие журналы ведутся при ТО?", options:["Журнал дефектов, акты испытаний, записи о ремонте","Только журнал учета","Только отчет","Никакие"], correct:"a"},
    {question:"Можно ли вводить оборудование без проверки?", options:["Нет","Да","Только иногда","Только при малых ремонтах"], correct:"a"},
    {question:"Кто проводит испытания изоляции?", options:["Квалифицированный персонал с приборами","Любой","Только инженер","Подрядчик"], correct:"a"},
    {question:"Что фиксируют в актах выполненных работ?", options:["Описание работ, результаты испытаний и подписи ответственных","Только подписи","Только дату","Ничего"], correct:"a"}
  ],
  naryad: [
    {question:"Что такое наряд-допуск?", options:["Письменный документ, определяющий место, объем и меры безопасности работ","Устное распоряжение","Только журнал","Только запись"], correct:"a"},
    {question:"Кто выдает наряд-допуск?", options:["Выдающий, уполномоченный организацией","Любой работник","Только инженер","Диспетчер"], correct:"a"},
    {question:"Что указывается в наряде для работ на ВЛ?", options:["Меры по отключению, заземлению, ограждению и состав бригады","Только место","Только время","Ничего"], correct:"a"},
    {question:"Когда наряд можно продлить?", options:["По регламенту и только один раз при необходимости","Никогда","Неограниченно","По устной договоренности"], correct:"a"},
    {question:"Кто должен проводить инструктаж по наряду?", options:["Допускающий и производитель работ","Сам работник","Только выдающий","Диспетчер"], correct:"a"},
    {question:"Как закрывается наряд?", options:["Подписанием допускающего и производителя работ","Устно","Только записью в журнале","Без оформления"], correct:"a"},
    {question:"Можно ли выдавать наряд при наличии опасных факторов без мер защиты?", options:["Нет","Да","Только после предупреждения","Только под наблюдением"], correct:"a"},
    {question:"Какие отметки обязательны в наряде?", options:["Подписи и время начала/окончания","Только подписи","Только время","Ничего"], correct:"a"},
    {question:"Кто может отозвать наряд в процессе работ?", options:["Допускающий или выдающий при возникновении опасности","Любой рабочий","Только руководитель","Никто"], correct:"a"},
    {question:"Как хранить закрытые наряды?", options:["В установленном порядке и сроки, согласно локальным правилам","Уничтожать","Только в электронном виде","Не хранить"], correct:"a"}
  ],
  safety: [
    {question:"Какие СИЗ обязательны при работе с электроустановками?", options:["Каска, изолирующие перчатки, защитная обувь, очки при необходимости","Только каска","Только перчатки","Никакие"], correct:"a"},
    {question:"Что означает плакат «Не включать! Работают люди»?", options:["Запрет включения до снятия плаката и подтверждения безопасности","Просто информация","Необязательно","Только предупреждение"], correct:"a"},
    {question:"Какие меры снижают риск дуги?", options:["Соблюдение дистанций, правильное заземление, СИЗ и барьеры","Только плакаты","Ничего","Только отключение"], correct:"a"},
    {question:"Можно ли работать без инструктажа?", options:["Нет, инструктаж обязателен перед началом работ","Да","Только при опыте","Только днем"], correct:"a"},
    {question:"Какую роль играет контроль за соблюдением СИЗ?", options:["Обеспечивает снижение рисков и защиту персонала","Не влияет","Только формальность","Только для отчётности"], correct:"a"},
    {question:"Что такое допустимый уровень ошибок при тестировании?", options:["Устанавливается организацией/регламентом","Всегда 0","10 ошибок","Не имеет значения"], correct:"a"},
    {question:"Кто отвечает за обучение по СИЗ?", options:["Работодатель/ответственные лица","Сам работник","Только внешние службы","Никто"], correct:"a"},
    {question:"Какие плакаты обязательны на месте работ?", options:["Предупреждающие и информационные: запреты на включение, заземлено и др.","Только указатели","Никакие","Только информационные"], correct:"a"},
    {question:"Можно ли использовать поврежденные СИЗ?", options:["Нет, поврежденные СИЗ изымаются из эксплуатации","Да","Только временно","Только при отсутствии запаса"], correct:"a"},
    {question:"Что необходимо при работе в ограниченных пространствах?", options:["Особые меры безопасности, газоанализ и разрешение","Ничего","Только фонарь","Только сопровождение"], correct:"a"}
  ],
  grounding: [
    {question:"Что такое защитное заземление?", options:["Соединение с землей для отвода токов утечки и снижения риска поражения","Только измерение сопротивления","Только молниезащита","Покраска"], correct:"a"},
    {question:"Когда применяют переносные заземления?", options:["На отключенных участках для защиты от случайного появления напряжения","На включенных участках","Только для генераторов","Не применяют"], correct:"a"},
    {question:"Как проверяют сопротивление заземления?", options:["Измерителем сопротивления заземления","Визуально","По журналу","Не проверяют"], correct:"a"},
    {question:"Что такое выравнивание потенциалов?", options:["Создание одинакового потенциала между металлич. частями для уменьшения ударов","Покраска частей","Изоляция","Не применяют"], correct:"a"},
    {question:"Кто отвечает за состояние заземления на объекте?", options:["Ответственный за электрохозяйство","Любой","Производитель работ","Диспетчер"], correct:"a"},
    {question:"Можно ли использовать временные заземления постоянно?", options:["Нет, временные заземления — временные меры","Да","Только зимой","Только на стройке"], correct:"a"},
    {question:"Какие требования к заземляющему проводнику?", options:["Соответствие нормам по сечению и материалу","Произвольные","Только медные","Только оцинкованные"], correct:"a"},
    {question:"Когда обязательно измерять заземление после ремонта?", options:["Перед вводом в эксплуатацию","Никогда","Только по просьбе","Раз в год"], correct:"a"},
    {question:"Что фиксируется при проверке заземления?", options:["Результаты измерений и дата, подписи ответственных","Только дата","Ничего","Только устно"], correct:"a"},
    {question:"Какие меры уменьшают коррозию заземления?", options:["Правильный выбор материала, контроль, обслуживание","Ничего","Только покраска","Только изоляция"], correct:"a"}
  ],
  tools: [
    {question:"Какие требования к электроинструменту?", options:["Изолированные, сертифицированные и испытанные инструменты","Любой инструмент","Только новые","Нет требований"], correct:"a"},
    {question:"Как обращаться с поврежденным инструментом?", options:["Изъять и пометить для ремонта/утилизации","Использовать дальше","Скрыть дефект","Продать"], correct:"a"},
    {question:"Как хранить электроинструмент?", options:["В сухом защищенном месте и по инструкциям","На улице","В грязи","Без упаковки"], correct:"a"},
    {question:"Какая проверка обязательна перед использованием инструмента?", options:["Целостность изоляции и маркировка","Никакая","Только внешний вид","Только заряд"], correct:"a"},
    {question:"Можно ли использовать удлинители без ограничений?", options:["Нет, не перегружать и использовать по назначению","Да","Только вечером","Только для освещения"], correct:"a"},
    {question:"Какие светильники применяются в опасных зонах?", options:["Взрывозащищенные или искробезопасные при необходимости","Любые","Только лампы накаливания","Без требований"], correct:"a"},
    {question:"Кто отвечает за исправность инструментов?", options:["Работодатель / служба по электрохозяйству","Работник","Поставщик","Никто"], correct:"a"},
    {question:"Когда нужно проводить поверку инструмента?", options:["По регламенту и после дефектов","Никогда","Только при покупке","Раз в 20 лет"], correct:"a"},
    {question:"Можно ли использовать самодельные переходники?", options:["Нет, запрещено","Да","Только при проверке","Только в экстренных случаях"], correct:"a"},
    {question:"Что проверяют при приемке инструмента в бригаду?", options:["Наличие маркировки, целостность и испытания","Только внешний вид","Ничего","Только упаковку"], correct:"a"}
  ],
  dispatcher: [
    {question:"Кто выполняет диспетчерские переключения?", options:["Диспетчер/оперативный персонал, уполномоченный и обученный","Любой работник","Руководитель","Инженер"], correct:"a"},
    {question:"Что необходимо перед переключением?", options:["Согласование, проверка готовности исполнителей и мер безопасности","Только устное разрешение","Ничего","Только запись"], correct:"a"},
    {question:"Как документируется оперативное переключение?", options:["Записью в оперативном журнале и распоряжениях","Устно","Не документируется","Только по телефону"], correct:"a"},
    {question:"Кто отвечает за связь между бригадой и диспетчером?", options:["Назначенные ответственные лица и системы связи","Никто","Бригада","Только инженер"], correct:"a"},
    {question:"Когда допускается внеплановое переключение?", options:["Только при аварии и по регламенту","Всегда","По желанию","Не допускается"], correct:"a"},
    {question:"Какие данные передаются при смене диспетчера?", options:["Состояние оборудования, незавершенные работы и замечания","Ничего","Только время","Только люди"], correct:"a"},
    {question:"Какую роль играет диспетчер при аварии?", options:["Координация действий, уведомление ответственных и организация работ","Никакую","Только отчет","Только звонки"], correct:"a"},
    {question:"Кто контролирует выполнение распоряжений диспетчера?", options:["Оперативный персонал и руководители работ","Никто","Только руководство","Только инспектор"], correct:"a"},
    {question:"Что важно при согласовании переключений?", options:["Подтверждение готовности и протокол действий","Только устное согласие","Ничего","Только электронная почта"], correct:"a"},
    {question:"Какие документы сопутствуют оперативным переключениям?", options:["Журналы, распоряжения и протоколы","Устные распоряжения","Только записи","Ничего"], correct:"a"}
  ],
  firstaid: [
    {question:"Что делать при поражении электрическим током?", options:["Отключить источник, оказать первую помощь, вызвать медпомощь","Оставить пострадавшего","Переместить сразу","Ничего"], correct:"a"},
    {question:"Можно ли трогать пострадавшего до отключения источника?", options:["Нет, сначала обезопасить источник или использовать изолирующие средства","Да","Только в перчатках","Только руководитель"], correct:"a"},
    {question:"Какие средства первой помощи должны быть на участке?", options:["Аптечка, средства для СЛР и остановки кровотечения","Ничего","Только бинты","Только антисептики"], correct:"a"},
    {question:"Что делать при ожоге от дуги?", options:["Охладить пораженное место, покрыть стерильной повязкой, вызвать врача","Мазать мазью","Тереть","Ничего"], correct:"a"},
    {question:"Кто оказывает первую помощь до приезда медиков?", options:["Обученный персонал или ответственные лица на объекте","Любой","Только врач","Только медсестра"], correct:"a"},
    {question:"Что делать при остановке дыхания?", options:["Начать СЛР, вызвать скорую и продолжать до прибытия помощи","Ждать","Только согреть","Только дать воду"], correct:"a"},
    {question:"Когда нужна эвакуация при аварии?", options:["При угрозе пожара, взрыва или утечки опасных веществ","Только по приказу директора","Никогда","Только при громком звуке"], correct:"a"},
    {question:"Какие навыки должны иметь сотрудники по первой помощи?", options:["Базовые навыки СЛР и действия при поражении током","Никаких","Только руководители","Только медики"], correct:"a"},
    {question:"Можно ли перемещать пострадавшего с серьезными травмами самостоятельно?", options:["Только если это безопасно и необходимо для спасения, иначе ждать специалистов","Всегда","Никогда","Только при наличии транспорта"], correct:"a"},
    {question:"Что важнее при оказании первой помощи?", options:["Быстро и правильно обезопасить место и вызвать медпомощь","Делать всё самому","Игнорировать","Только сообщить по телефону"], correct:"a"}
  ]
};

/* ===========================
   Утилиты
   =========================== */
function normalize(s){ return (s||'').toString().trim(); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }
function saveLocal(){ localStorage.setItem('qe_bank', JSON.stringify(questionBank)); localStorage.setItem('qe_names', JSON.stringify(categoryNames)); renderCategories(); generateCsvPreview(); }
function loadLocal(){ try{ const qb=JSON.parse(localStorage.getItem('qe_bank')); const cn=JSON.parse(localStorage.getItem('qe_names')); if(qb && cn){ questionBank=qb; categoryNames=cn; return true; } }catch(e){} return false; }

/* ===========================
   UI: рендер категорий
   =========================== */
function renderCategories(){
  const grid = document.getElementById('categoryGrid'); grid.innerHTML='';
  Object.keys(questionBank).forEach(key=>{
    const div=document.createElement('div'); div.className='category-item';
    const left=document.createElement('div'); left.style.display='flex'; left.style.gap='8px'; left.style.alignItems='center';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=true; chk.dataset.key=key; chk.onchange=()=>div.classList.toggle('selected', chk.checked);
    left.appendChild(chk);
    const lbl=document.createElement('label'); lbl.textContent = `${categoryNames[key]||key} (${questionBank[key].length})`;
    left.appendChild(lbl);
    div.appendChild(left);
    const controls=document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
    const addBtn=document.createElement('button'); addBtn.className='btn btn-primary'; addBtn.textContent='Добавить'; addBtn.onclick=()=>openAddQuestion(key);
    const viewBtn=document.createElement('button'); viewBtn.className='btn btn-secondary'; viewBtn.textContent='Просмотр'; viewBtn.onclick=()=>openCategoryViewer(key);
    controls.appendChild(addBtn); controls.appendChild(viewBtn);
    div.appendChild(controls);
    grid.appendChild(div);
  });
}

/* ===========================
   Админ: добавить/редактировать/удалять вопросы
   =========================== */
function openAddQuestion(catKey){
  editingCat = catKey; editIndex = null;
  document.getElementById('currentCatKey').value = catKey;
  document.getElementById('currentCatName').textContent = categoryNames[catKey] || catKey;
  document.getElementById('questionInput').value=''; document.getElementById('optionA').value=''; document.getElementById('optionB').value=''; document.getElementById('optionC').value=''; document.getElementById('optionD').value=''; document.getElementById('correctSelect').value='a';
  window.scrollTo({top:0,behavior:'smooth'});
}

function openCategoryViewer(catKey){
  const win = window.open('','view','width=900,height=700,scrollbars=yes');
  const name = categoryNames[catKey] || catKey;
  let html = `<html><head><meta charset="utf-8"><title>Категория: ${name}</title><style>body{font-family:Arial;padding:12px} .q{padding:8px;border-bottom:1px solid #eee} button{margin-left:8px}</style></head><body><h2>Категория: ${name}</h2><div>`;
  questionBank[catKey].forEach((q,i)=>{
    const opts = q.options.map((o,idx)=>`${String.fromCharCode(97+idx)}) ${o}`).join(' | ');
    html += `<div class="q"><b>${i+1}.</b> ${q.question}<div style="color:#444;margin-top:6px">${opts}</div><div style="margin-top:6px">Правильный: <b>${q.correct}</b> <button onclick="opener.editQ('${catKey}',${i})">Редактировать</button> <button onclick="opener.deleteQ('${catKey}',${i})">Удалить</button></div></div>`;
  });
  html += `</div><p><button onclick="window.close()">Закрыть</button></p></body></html>`;
  win.document.write(html); win.document.close();
}
window.editQ = function(cat,i){
  window.focus();
  const q = questionBank[cat][i];
  editingCat = cat; editIndex = i;
  document.getElementById('currentCatKey').value = cat;
  document.getElementById('currentCatName').textContent = categoryNames[cat] || cat;
  document.getElementById('questionInput').value = q.question;
  document.getElementById('optionA').value = q.options[0]||'';
  document.getElementById('optionB').value = q.options[1]||'';
  document.getElementById('optionC').value = q.options[2]||'';
  document.getElementById('optionD').value = q.options[3]||'';
  document.getElementById('correctSelect').value = q.correct;
  alert('Редактируй в форме и нажми "Сохранить".');
}
window.deleteQ = function(cat,i){ if(!confirm('Удалить вопрос?')) return; questionBank[cat].splice(i,1); saveLocal(); alert('Удалено'); }

/* Сохранить вопрос */
document.getElementById('saveQuestionBtn').addEventListener('click', ()=>{
  const cat = document.getElementById('currentCatKey').value || editingCat;
  if(!cat){ alert('Выбери категорию (кнопка Добавить рядом с категорией)'); return; }
  const qtext = normalize(document.getElementById('questionInput').value);
  const a = normalize(document.getElementById('optionA').value);
  const b = normalize(document.getElementById('optionB').value);
  const c = normalize(document.getElementById('optionC').value);
  const d = normalize(document.getElementById('optionD').value);
  const correct = document.getElementById('correctSelect').value;
  if(!qtext||!a||!b||!c||!d){ alert('Заполни все поля'); return; }
  const qObj = {question:qtext, options:[a,b,c,d], correct:correct};
  const exists = questionBank[cat].some((q,idx)=> q.question===qtext && (editIndex===null || editIndex!==idx));
  if(exists && !confirm('Похожий вопрос уже есть — добавить всё равно?')) return;
  if(editIndex!==null){ questionBank[cat][editIndex]=qObj; editIndex=null; } else questionBank[cat].push(qObj);
  saveLocal(); alert('Сохранено');
});

/* Удалить редактируемый */
document.getElementById('deleteQuestionBtn').addEventListener('click', ()=>{
  if(editIndex===null){ alert('Ничего для удаления не выбрано'); return; }
  if(confirm('Удалить редактируемый вопрос?')){ questionBank[editingCat].splice(editIndex,1); editIndex=null; saveLocal(); alert('Удалено'); }
});
document.getElementById('cancelEditBtn').addEventListener('click', ()=>{ editIndex=null; document.getElementById('questionInput').value=''; document.getElementById('optionA').value=''; document.getElementById('optionB').value=''; document.getElementById('optionC').value=''; document.getElementById('optionD').value=''; });

/* Создать категорию */
document.getElementById('createCatBtn').addEventListener('click', ()=>{
  const key = normalize(document.getElementById('newCatKey').value).toLowerCase();
  const name = normalize(document.getElementById('newCatName').value);
  if(!key||!name){ alert('Введите ключ и название'); return; }
  if(!/^[a-z0-9_]+$/i.test(key)){ alert('Ключ: латинские буквы, цифры, подчёркивание'); return; }
  if(questionBank[key]){ alert('Ключ уже существует'); return; }
  questionBank[key]=[]; categoryNames[key]=name; saveLocal(); document.getElementById('newCatKey').value=''; document.getElementById('newCatName').value=''; renderCategories();
});

/* ===========================
   CSV генерация / импорт / экспорт
   =========================== */
function generateCsv(){
  const lines=['category,question,options,correct'];
  Object.keys(questionBank).forEach(cat=>{
    questionBank[cat].forEach(q=>{
      const opts = q.options.map(o=> (o||'').replace(/"/g,'""')).join(CSV_OPTIONS_SEP);
      const qEsc = (q.question||'').replace(/"/g,'""');
      lines.push(`${cat},"${qEsc}","${opts}",${q.correct}`);
    });
  });
  return lines.join('\n');
}
document.getElementById('generateCsvBtn').addEventListener('click', ()=>{ const csv = generateCsv(); document.getElementById('csvArea').value = csv; alert('CSV сгенерирован.'); });
document.getElementById('downloadCsvBtn').addEventListener('click', ()=>{ const csv = document.getElementById('csvArea').value || generateCsv(); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='questions_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

function csvSplit(line){
  const res=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ inQ=!inQ; cur+=ch; continue; } if(ch===',' && !inQ){ res.push(cur.trim()); cur=''; continue; } cur+=ch; }
  if(cur!=='') res.push(cur.trim()); return res;
}
function parseCsvText(text, replace=true){
  const rows = text.split(/\r?\n/).filter(r=>r.trim().length>0);
  let dataRows = rows;
  if(rows[0] && rows[0].toLowerCase().includes('category') && rows[0].toLowerCase().includes('question')) dataRows = rows.slice(1);
  const newBank = replace ? {} : JSON.parse(JSON.stringify(questionBank));
  const newNames = replace ? {} : JSON.parse(JSON.stringify(categoryNames));
  dataRows.forEach(r=>{
    const parts = csvSplit(r);
    if(parts.length < 4) return;
    const cat = normalize(parts[0]) || 'misc';
    const qText = parts[1].replace(/^"|"$/g,'').trim();
    const optsRaw = parts[2].replace(/^"|"$/g,'').trim();
    let opts = optsRaw.split(CSV_OPTIONS_SEP);
    if(opts.length===1){ if(optsRaw.indexOf(';')>=0) opts = optsRaw.split(';'); else if(optsRaw.indexOf(',')>=0) opts = optsRaw.split(','); }
    opts = opts.map(o=> o.replace(/^"|"$/g,'').trim()).slice(0,4);
    while(opts.length<4) opts.push('---');
    const correct = (parts[3]||'').replace(/^"|"$/g,'').trim().toLowerCase();
    if(!newBank[cat]) newBank[cat]=[];
    if(!newNames[cat]) newNames[cat]=cat;
    const exists = newBank[cat].some(q => q.question === qText);
    if(!exists) newBank[cat].push({question:qText, options:opts, correct: (['a','b','c','d'].includes(correct)?correct:'b')});
  });
  questionBank = newBank; categoryNames = newNames; saveLocal(); renderCategories(); generateCsvPreview(); alert('Импорт выполнен');
}
document.getElementById('importCsvBtn').addEventListener('click', ()=>{ const txt=document.getElementById('csvArea').value.trim(); if(!txt){ alert('Вставь CSV'); return; } if(!confirm('Импорт заменит базу. Продолжить?')) return; parseCsvText(txt, true); });
document.getElementById('mergeCsvBtn').addEventListener('click', ()=>{ const txt=document.getElementById('csvArea').value.trim(); if(!txt){ alert('Вставь CSV'); return; } parseCsvText(txt, false); });

function generateCsvPreview(){ document.getElementById('csvArea').value = generateCsv(); }

/* ===========================
   Работа с публичной CSV (fetch)
   =========================== */
document.getElementById('loadPublicCsvBtn').addEventListener('click', async ()=>{
  const url = document.getElementById('publicCsv').value.trim();
  if(!url){ alert('Вставь публичную CSV ссылку'); return; }
  try{
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error('Network response not ok');
    const txt = await r.text();
    parseCsvText(txt, true);
    alert('CSV загружен из публичной ссылки.');
  }catch(e){ console.error(e); alert('Ошибка загрузки CSV: ' + e.message); }
});

/* ===========================
   Apps Script: отправка данных POST
   =========================== */
document.getElementById('saveToAppsBtn').addEventListener('click', ()=>{
  const url = document.getElementById('appsScriptUrl').value.trim();
  if(!url){ alert('Вставь Apps Script Web App URL (exec)'); return; }
  // соберём массив
  const rows = [];
  Object.keys(questionBank).forEach(cat=>{
    questionBank[cat].forEach(q=>{
      const opts = q.options.map(o=> (o||'').replace(/\n/g,' ')).join(CSV_OPTIONS_SEP);
      rows.push([cat, q.question, opts, q.correct]);
    });
  });
  fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(rows) })
    .then(r => r.text())
    .then(t => { alert('Ответ от Apps Script: ' + t); })
    .catch(e => { console.error(e); alert('Failed to fetch — проверь URL, права доступа и запусти файл через http(s) (не file://).'); });
});

/* ===========================
   Тест: запуск, показ вопросов и логика
   =========================== */
document.getElementById('startBtn').addEventListener('click', ()=>{
  const checked = Array.from(document.querySelectorAll('.category-grid input[type=checkbox]')).filter(i=>i.checked).map(i=>i.dataset.key);
  if(checked.length===0){ alert('Выбери категории'); return; }
  let all = [];
  checked.forEach(k=> all = all.concat(questionBank[k] || []));
  const uniq=[]; const seen=new Set();
  all.forEach(q=>{ if(!seen.has(q.question)){ seen.add(q.question); uniq.push(q); }});
  if(uniq.length===0){ alert('В выбранных категориях нет вопросов'); return; }
  if(document.getElementById('questionCount')) {
    const qc = parseInt(document.getElementById('questionCount').value) || 20;
    if(document.getElementById('randomOrder') && document.getElementById('randomOrder').checked) shuffle(uniq);
    currentQuestions = uniq.slice(0, Math.min(qc, uniq.length));
  } else currentQuestions = uniq;
  totalQuestions = currentQuestions.length;
  currentIndex = 0; correctCount = 0; incorrectCount = 0; failureLimit = parseInt(document.getElementById('failureLimit').value) || 3;
  // UI show
  document.getElementById('setupCard').classList.add('hidden');
  document.getElementById('adminCard').classList.add('hidden');
  document.getElementById('quizCard').classList.remove('hidden');
  loadQuestion();
  updateProgress();
});

function loadQuestion(){
  if(currentIndex >= totalQuestions || incorrectCount >= failureLimit){ showResults(); return; }
  const q = currentQuestions[currentIndex];
  const opts = q.options.slice();
  let indices = [0,1,2,3];
  // shuffle options for variability
  shuffle(indices);
  const origCorrectIndex = {'a':0,'b':1,'c':2,'d':3}[q.correct] || 0;
  const newCorrect = ['a','b','c','d'][indices.indexOf(origCorrectIndex)];
  const cont = document.getElementById('optionsContainer'); cont.innerHTML = '';
  indices.forEach((orig, i)=>{
    const div = document.createElement('div'); div.className='option'; div.textContent = opts[orig] || '---';
    div.dataset.value = ['a','b','c','d'][i];
    div.onclick = ()=> selectOption(div, newCorrect);
    cont.appendChild(div);
  });
  document.getElementById('questionText').textContent = q.question;
  document.getElementById('nextBtn').disabled = true;
  updateProgress();
}

function selectOption(el, correct){
  const opts = document.querySelectorAll('.option'); opts.forEach(o=>o.classList.add('disabled'));
  const sel = el.dataset.value;
  if(sel === correct){ el.classList.add('correct'); correctCount++; }
  else { el.classList.add('incorrect'); incorrectCount++; opts.forEach(o=>{ if(o.dataset.value === correct) o.classList.add('correct'); }); }
  document.getElementById('nextBtn').disabled = false;
  updateProgress();
}
document.getElementById('nextBtn').addEventListener('click', ()=>{ currentIndex++; if(currentIndex < totalQuestions && incorrectCount < failureLimit) loadQuestion(); else showResults(); });
document.getElementById('quitBtn').addEventListener('click', ()=>{ if(confirm('Прервать тест?')) backToSetup(); });

function showResults(){
  document.getElementById('quizCard').classList.add('hidden');
  document.getElementById('resultCard').classList.remove('hidden');
  const score = Math.round((correctCount / Math.max(1,totalQuestions)) * 100);
  document.getElementById('finalScore').textContent = score + '%';
  document.getElementById('finalCorrect').textContent = correctCount;
  document.getElementById('finalIncorrect').textContent = incorrectCount;
  document.getElementById('finalTotal').textContent = totalQuestions;
  document.getElementById('resultTitle').textContent = (score >= 80) ? 'Тест успешно пройден!' : 'Тест не пройден';
}
document.getElementById('restartBtn').addEventListener('click', ()=>{ currentIndex=0; correctCount=0; incorrectCount=0; shuffle(currentQuestions); document.getElementById('resultCard').classList.add('hidden'); document.getElementById('quizCard').classList.remove('hidden'); loadQuestion(); updateProgress(); });
document.getElementById('backSetupBtn').addEventListener('click', backToSetup);
function backToSetup(){ document.getElementById('resultCard').classList.add('hidden'); document.getElementById('quizCard').classList.add('hidden'); document.getElementById('setupCard').classList.remove('hidden'); document.getElementById('adminCard').classList.remove('hidden'); }
function updateProgress(){ document.getElementById('questionProgress').textContent = `Вопрос ${Math.min(currentIndex+1,totalQuestions)} из ${totalQuestions}`; document.getElementById('correctCount').textContent = correctCount; document.getElementById('incorrectCount').textContent = incorrectCount; const pct = Math.round(((currentIndex) / (totalQuestions===0?1:totalQuestions)) * 100); document.getElementById('progressFill').style.width = pct + '%'; }

/* ===========================
   Инициализация: загрузка локальной базы или localStorage и определение режима
   =========================== */
function loadDefaults(){
  questionBank = JSON.parse(JSON.stringify(defaultQuestionBank));
  categoryNames = JSON.parse(JSON.stringify(defaultCategoryNames));
  saveLocal();
  renderCategories();
  generateCsvPreview();
}
function init(){
  // определяем режим по протоколу
  const isFile = location.protocol === 'file:';
  document.getElementById('modeLabel').textContent = isFile ? 'offline (file://)' : 'online (http/https)';
  // загрузка из localStorage или дефолт
  if(!loadLocal()){ loadDefaults(); } else { renderCategories(); generateCsvPreview(); }
  // если online — попробуем подтянуть публичную CSV автоматически (не навязчиво)
  if(!isFile){
    const pub = document.getElementById('publicCsv').value.trim();
    if(pub){
      fetch(pub, {cache:'no-store'}).then(r=> r.ok ? r.text() : Promise.reject('no') ).then(txt=>{ parseCsvText(txt, true); console.info('Public CSV loaded'); }).catch(()=>{ console.info('Public CSV not loaded'); });
    }
  }
  // hide admin by default
  document.getElementById('adminCard').classList.add('hidden');
}
window.addEventListener('DOMContentLoaded', init);

/* Кнопки UI */
document.getElementById('openAdminBtn').addEventListener('click', ()=>{ document.getElementById('adminCard').classList.toggle('hidden'); });
document.getElementById('clearLocalBtn').addEventListener('click', ()=>{ if(confirm('Сбросить локальную базу и вернуть встроенную?')){ localStorage.removeItem('qe_bank'); localStorage.removeItem('qe_names'); loadDefaults(); alert('Сброшено'); } });

/* Поддержка изменения SpreadsheetId по полю - используется при записи через Apps Script */
document.getElementById('spreadsheetId').addEventListener('change', (e)=>{ /* Если нужно, используем при записи внутри Apps Script владельца */ });

</script>
</body>
</html>
