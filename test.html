<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Комплексный тест по электробезопасности (РК, 2025) — офлайн/онлайн</title>
<style>
  :root{ --p:#6366f1; --p2:#7c3aed; --ok:#16a34a; --bad:#ef4444; --bg:#0f172a; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;margin:0;background:linear-gradient(135deg,var(--p) 0%,var(--p2) 100%);min-height:100vh;color:#111}
  .wrap{max-width:1000px;margin:0 auto;padding:16px 16px 60px}
  .card{background:#fff;border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.15);padding:22px;margin:14px 0}
  h1{color:#fff;text-align:center;text-shadow:0 2px 8px rgba(0,0,0,.25);font-weight:800;letter-spacing:.3px}
  .muted{opacity:.9;color:#e5e7eb;text-align:center;margin-top:6px}
  input[type=text],input[type=url],select,textarea{width:100%;border:2px solid #e2e8f0;border-radius:12px;padding:10px 12px;font-size:14px}
  .btn{border:0;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--p);color:#fff}
  .btn-ghost{background:#f3f4f6}
  .btn-danger{background:var(--bad);color:#fff}
  .btn-green{background:var(--ok);color:#fff}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid #e2e8f0;padding:8px 10px;border-radius:999px}
  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
  .kpi .item{background:#f8fafc;border-left:5px solid var(--p);padding:16px;border-radius:12px}
  .kpi .val{font-size:26px;font-weight:800;color:var(--p)}
  .kpi .lbl{font-size:12px;text-transform:uppercase;color:#6b7280;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}

  /* category / accordion tweaks */
  .category{border:2px solid #e2e8f0;border-radius:12px;background:#f8fafc;padding:12px;margin:10px 0;overflow:hidden}
  .category .hdr{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:6px 8px;border-radius:8px;background:#eef2ff}
  .category .hdr b{color:#111827}
  .qlist{max-height:0;overflow:hidden;transition:max-height .35s ease;padding:0}
  .category.open .qlist{max-height:2000px;padding:10px}

  .qitem{display:flex;align-items:center;justify-content:space-between;padding:6px;border-radius:8px;background:#fff;margin:6px 0;border:1px solid #e6e9ef}
  .qtext{font-size:13px;color:#334155;margin-right:8px;flex:1}
  .small{font-size:12px;padding:6px 8px;border-radius:8px}
  .editor-inline{background:#f9fafb;border:1px solid #cbd5e1;border-radius:8px;padding:10px;margin-top:6px}
  .editor-inline input,.editor-inline select{width:100%;margin-bottom:6px;padding:6px;border:1px solid #d1d5db;border-radius:6px;font-size:13px}

  .hidden{display:none}
  .error{background:#fef2f2;color:#991b1b;border-left:4px solid #ef4444;padding:10px;border-radius:10px;margin:8px 0;display:none}
  .success{background:#ecfdf5;color:#065f46;border-left:4px solid #10b981;padding:10px;border-radius:10px;margin:8px 0;display:none}
  .foot{color:#e5e7eb;text-align:center;margin-top:8px}
  .badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
  .tools{display:flex;gap:10px;flex-wrap:wrap}
  .note{font-size:13px;color:#475569}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Комплексный тест по электробезопасности — РК 2025</h1>
    <div class="muted">Основано на ПТЭЭП (Приказ №246 от 30.03.2015 с изм. от 17.01.2025 №22‑н/қ) и ПТБ (Приказ №222 от 19.03.2015). Режимы: офлайн и онлайн.</div>

    <!-- НАСТРОЙКИ/ЗАГРУЗКА -->
    <div class="card" id="setup">
      <div class="row">
        <div>
          <label>Режим работы</label>
          <div class="tools">
            <button class="btn btn-primary" id="modeOffline">Офлайн (локальная база)</button>
            <button class="btn btn-ghost" id="modeOnline">Онлайн (Google Sheets + Apps Script)</button>
            <span class="pill"><span class="badge" id="modeBadge">ОФЛАЙН</span> <span id="modeNote">работа из локальной базы и LocalStorage</span></span>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>URL CSV Google Sheets</label>
          <input type="url" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv">
          <div class="note">Можно вставить любой публичный CSV.</div>
        </div>
        <div>
          <label>Apps Script Web App URL (для сохранения/экспорта)</label>
          <input type="url" id="appsUrl" placeholder="https://script.google.com/macros/s/.../exec">
          <div class="note">Вставьте опубликованный URL веб‑приложения (Deploy → Web app → Anyone).</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Количество вопросов в тесте</label>
          <select id="questionCount">
            <option>20</option><option selected>30</option><option>40</option><option>50</option><option>100</option>
          </select>
        </div>
        <div>
          <label>Порог ошибок (шт.)</label>
          <select id="failureLimit"><option>2</option><option selected>3</option><option>5</option><option>10</option></select>
        </div>
        <div>
          <label>Случайный порядок</label>
          <select id="randomOrder"><option value="1" selected>Да</option><option value="0">Нет</option></select>
        </div>
      </div>

      <div class="row">
        <div class="tools">
          <button class="btn btn-primary" id="btnLoadRemote">Загрузить из Google Sheets</button>
          <button class="btn btn-green" id="btnSaveApps">Сохранить через Apps Script</button>
          <button class="btn btn-ghost" id="btnExport">Экспорт JSON</button>
          <button class="btn btn-ghost" id="btnImport">Импорт JSON</button>
          <input type="file" id="fileImport" accept="application/json" class="hidden" />
        </div>
      </div>

      <div class="error" id="errBox"></div>
      <div class="success" id="okBox"></div>

      <div class="row">
        <div class="grid" id="catGrid"></div>
      </div>

      <div class="row">
        <div class="card" style="flex:1">
          <div class="row">
            <div><label>Новая категория (ключ латиницей)</label><input type="text" id="newCatKey" placeholder="org, special, access, ..."></div>
            <div><label>Название категории</label><input type="text" id="newCatName" placeholder="Организационные, Взрывоопасные зоны, Допуски ..."></div>
          </div>
          <div class="tools" style="margin-top:8px">
            <button class="btn btn-primary" id="btnAddCat">Добавить категорию</button>
            <select id="delCatSel"></select>
            <button class="btn btn-danger" id="btnDelCat">Удалить категорию</button>
            <button class="btn btn-ghost" id="btnAutosave">Автосохранение: выкл</button>
          </div>
        </div>
      </div>

      <div class="row" id="editorWrap">
        <div class="card" id="editor">
          <div class="row">
            <div><label>Категория</label><select id="edCat"></select></div>
            <div style="min-width:340px"><label>Вопрос</label><input type="text" id="edQ"></div>
          </div>
          <div class="row">
            <div><label>Вариант A</label><input type="text" id="edA"></div>
            <div><label>Вариант B</label><input type="text" id="edB"></div>
            <div><label>Вариант C</label><input type="text" id="edC"></div>
            <div><label>Вариант D</label><input type="text" id="edD"></div>
            <div><label>Правильный</label>
              <select id="edCorrect"><option value="a">a</option><option value="b">b</option><option value="c">c</option><option value="d">d</option></select>
            </div>
          </div>
          <div class="tools" style="margin-top:8px">
            <button class="btn btn-green" id="btnSaveQ">Сохранить вопрос</button>
            <button class="btn btn-ghost" id="btnCancelQ">Отмена</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="kpi">
          <div class="item"><div class="val" id="kpiCats">0</div><div class="lbl">Категорий</div></div>
          <div class="item"><div class="val" id="kpiQs">0</div><div class="lbl">Вопросов</div></div>
          <div class="item"><div class="val" id="kpiSel">0</div><div class="lbl">Выбрано для теста</div></div>
        </div>
      </div>

      <div class="tools">
        <button class="btn btn-primary" id="btnStart">Начать тест →</button>
      </div>
    </div>

    <!-- ТЕСТ -->
    <div class="card hidden" id="quiz">
      <div class="row" style="align-items:center">
        <div class="pill">Прогресс: <b id="progressText">0/0</b></div>
        <div class="pill">Верно: <b id="okCnt">0</b></div>
        <div class="pill">Ошибки: <b id="badCnt">0</b> / <span id="badMax">3</span></div>
      </div>
      <div class="progress" style="margin:10px 0"><div id="progressBar"></div></div>

      <div class="question" id="qText"></div>
      <div id="optBox"></div>

      <div class="tools">
        <button class="btn btn-primary" id="btnNext" disabled>Следующий вопрос</button>
        <button class="btn btn-ghost" id="btnBackToSetup">← Вернуться к настройкам</button>
      </div>
    </div>

    <!-- РЕЗУЛЬТАТЫ -->
    <div class="card hidden" id="result">
      <h2 id="resTitle">Тест завершён</h2>
      <div class="kpi">
        <div class="item"><div class="val" id="resScore">0%</div><div class="lbl">Результат</div></div>
        <div class="item"><div class="val" id="resOk">0</div><div class="lbl">Правильных</div></div>
        <div class="item"><div class="val" id="resBad">0</div><div class="lbl">Ошибок</div></div>
      </div>
      <div class="tools" style="margin-top:10px">
        <button class="btn btn-ghost" id="btnAgain">Ещё раз</button>
        <button class="btn btn-primary" id="btnExportWrong">Сохранить ошибки в JSON</button>
      </div>
    </div>

    <div class="foot">Автосохранение: категории/вопросы кешируются в LocalStorage. При доступности сети можно загрузить Google Sheets, а сохранять — через Apps Script Web App.</div>
  </div>

<script>
// ======= ВСПОМОГАТЕЛЬНОЕ =======
const $ = sel => document.querySelector(sel);
function showOk(msg){ const box=$('#okBox'); box.textContent=msg; box.style.display='block'; setTimeout(()=>box.style.display='none',3500); }
function showErr(msg){ const box=$('#errBox'); box.textContent=msg; box.style.display='block'; setTimeout(()=>box.style.display='none',4500); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

// ======= CSV PARSER (RFC-like, handles quoted fields and newlines inside quotes) =======
function parseCSV(text){
  const rows = [];
  let field = '';
  let row = [];
  let inQuotes = false;
  for (let i = 0; i < text.length; i++){
    const ch = text[i];
    if (inQuotes){
      if (ch === '"'){
        if (text[i+1] === '"') { field += '"'; i++; } else { inQuotes = false; }
      } else { field += ch; }
    } else {
      if (ch === '"') { inQuotes = true; }
      else if (ch === ',') { row.push(field); field = ''; }
      else if (ch === '\r') { if (text[i+1] === '\n') { i++; } row.push(field); field = ''; rows.push(row); row = []; }
      else if (ch === '\n') { row.push(field); field = ''; rows.push(row); row = []; }
      else { field += ch; }
    }
  }
  // push last
  row.push(field);
  // if last row is not just an empty single cell, push
  if (!(row.length === 1 && row[0] === '')) rows.push(row);
  return rows;
}

// ======= НОРМАЛИЗАЦИЯ ОПЦИЙ =======
function normalizeOptionText(s){ return (s||'').toString().replace(/^[a-dA-D][\)\.\-\s]+/, '').trim(); }
function normalizeLoadedQuestion(item){ // ensure options are plain strings and correct is a/b/c/d
  if(!item || !Array.isArray(item.options)) return item;
  item.options = item.options.map(o => normalizeOptionText(o));
  if(typeof item.correct === 'string') item.correct = item.correct.trim().toLowerCase().charAt(0) || 'a';
  if(!['a','b','c','d'].includes(item.correct)) item.correct = 'a';
  return item;
}

// ======= ДАННЫЕ =======
let questionBank = {};      // {catKey: [{question, options:[a,b,c,d], correct:'a'..}]} 
let categoryNames = {};     // {catKey:'Название'}
let autosave = false;
let mode = 'offline';       // 'offline' | 'online'
let editMeta = null;        // {cat, index} when editing
let responses = [];        // user responses for current deck

// базовые категории
const baseCats = {
  org: 'Организационные и общие требования',
  access: 'Допуски, наряды, ответственность',
  ru: 'Работа в РУ и на подстанциях',
  lines: 'ЛЭП, подъем на опоры, высота',
  special: 'Взрывоопасные и газоопасные зоны',
  tools: 'Электроинструмент, СИЗ и испытания'
};

// ======= STORAGE =======
function saveLS(){
  try{
    localStorage.setItem('qbank', JSON.stringify(questionBank));
    localStorage.setItem('catnames', JSON.stringify(categoryNames));
    localStorage.setItem('sheetUrl', $('#sheetUrl').value.trim());
    localStorage.setItem('appsUrl', $('#appsUrl').value.trim());
    localStorage.setItem('autosave', autosave?'1':'0');
  }catch(e){ console.warn('LS save failed', e); }
}
function loadLS(){
  try{
    questionBank = JSON.parse(localStorage.getItem('qbank')||'{}')||{};
    categoryNames = JSON.parse(localStorage.getItem('catnames')||'{}')||{};
    // normalize
    for(const k of Object.keys(questionBank)){
      questionBank[k] = (questionBank[k]||[]).map(normalizeLoadedQuestion);
    }
  }catch(e){ questionBank={}; categoryNames={}; }
  $('#sheetUrl').value = localStorage.getItem('sheetUrl')||'';
  $('#appsUrl').value = localStorage.getItem('appsUrl')||'';
  autosave = localStorage.getItem('autosave')==='1';
  $('#btnAutosave').textContent = 'Автосохранение: ' + (autosave?'вкл':'выкл');
}
function ensureBase(){
  if(Object.keys(questionBank).length===0){
    for(const k in baseCats){ categoryNames[k]=baseCats[k]; questionBank[k]=[]; }
    // демонстрационные вопросы (опции — чистый текст)
    questionBank.org.push(normalizeLoadedQuestion({question:'Кто несёт ответственность за достаточность мер безопасности в наряде‑допуске?', options:['Допускающий','Выдающий наряд','Руководитель бригады','Ответственный за электрохозяйство'], correct:'b'}));
    questionBank.access.push(normalizeLoadedQuestion({question:'Какая группа по электробезопасности требуется для допускающего свыше 1000 В?', options:['II','III','IV','V'], correct:'c'}));
  }
}

// ======= UI: категории =======
function refreshKPI(){
  $('#kpiCats').textContent = Object.keys(questionBank).length;
  let total = 0; Object.values(questionBank).forEach(a=>total+=a.length);
  $('#kpiQs').textContent = total;
  const sel = [...document.querySelectorAll('.cat-check:checked')].map(i=>i.value);
  let selCnt = 0; sel.forEach(k=> selCnt += (questionBank[k]||[]).length ); $('#kpiSel').textContent = selCnt;
}

function renderCats(){
  const grid = $('#catGrid'); grid.innerHTML='';
  const delSel = $('#delCatSel'); delSel.innerHTML = '<option value="">Выберите категорию</option>';
  const edSel = $('#edCat'); edSel.innerHTML='';

  for(const key of Object.keys(questionBank)){
    const title = categoryNames[key] || key;
    const div = document.createElement('div'); div.className='category';
    const hdr = document.createElement('div'); hdr.className='hdr';
    const left = document.createElement('div');
    const chk = document.createElement('input'); chk.type='checkbox'; chk.className='cat-check'; chk.value=key; chk.checked=true; chk.onchange=refreshKPI;
    const lbl = document.createElement('b'); lbl.textContent = title + ' ('+(questionBank[key].length||0)+')';
    left.appendChild(chk); left.appendChild(lbl);
    const right = document.createElement('div');
    const addBtn = document.createElement('button'); addBtn.className='btn btn-primary'; addBtn.textContent='Добавить вопрос'; addBtn.onclick=()=>openEditor(key);
    right.appendChild(addBtn);
    hdr.appendChild(left); hdr.appendChild(right);

    // header click — разворачивание, но не при клике по кнопке или чекбоксу
    hdr.addEventListener('click', (e)=>{ if(e.target.closest('button')|| e.target.tagName==='INPUT') return; div.classList.toggle('open'); });

    div.appendChild(hdr);

    // список вопросов с кнопками редактирования/удаления
    const qlist = document.createElement('div'); qlist.className='qlist';
    (questionBank[key]||[]).forEach((q, idx)=>{
      const qi = document.createElement('div'); qi.className='qitem';
      const qtxt = document.createElement('div'); qtxt.className='qtext'; qtxt.textContent = (q.question.length>120? q.question.slice(0,117)+'...' : q.question);
      const tools = document.createElement('div');
      const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost small'; editBtn.textContent='Править'; editBtn.onclick = ()=>openEditorInline(qi, key, idx);
      const delBtn = document.createElement('button'); delBtn.className='btn btn-danger small'; delBtn.textContent='Удалить'; delBtn.onclick = ()=>{ if(!confirm('Удалить вопрос?')) return; questionBank[key].splice(idx,1); if(autosave) saveLS(); renderCats(); };
      tools.appendChild(editBtn); tools.appendChild(delBtn);
      qi.appendChild(qtxt); qi.appendChild(tools); qlist.appendChild(qi);
    });
    div.appendChild(qlist);

    grid.appendChild(div);

    const opt = document.createElement('option'); opt.value=key; opt.textContent=title; delSel.appendChild(opt);
    const opt2 = document.createElement('option'); opt2.value=key; opt2.textContent=title; edSel.appendChild(opt2);
  }
  refreshKPI();
}

// ======= РЕДАКТОР =======
function openEditor(cat, index=null){
  $('#editor').classList.remove('hidden');
  $('#edCat').value = cat || Object.keys(questionBank)[0] || '';
  $('#edQ').value = '';
  $('#edA').value = ''; $('#edB').value = ''; $('#edC').value=''; $('#edD').value=''; $('#edCorrect').value='a';
  if(index!==null && questionBank[cat] && questionBank[cat][index]){
    const it = questionBank[cat][index];
    $('#edQ').value = it.question;
    $('#edA').value = it.options[0]||''; $('#edB').value = it.options[1]||''; $('#edC').value = it.options[2]||''; $('#edD').value = it.options[3]||'';
    $('#edCorrect').value = (it.correct||'a');
    editMeta = {cat, index};
  } else { editMeta = null; }
}

// Inline editor — открывается прямо под вопросом
function openEditorInline(containerElem, cat, index){
  // удалим уже открытые inline-редакторы
  document.querySelectorAll('.editor-inline').forEach(e=>e.remove());
  const it = (questionBank[cat]||[])[index];
  if(!it) return;
  const ed = document.createElement('div'); ed.className='editor-inline';

  const inQ = document.createElement('input'); inQ.type='text'; inQ.value = it.question; inQ.placeholder='Вопрос';
  const inA = document.createElement('input'); inA.type='text'; inA.value = it.options[0]||''; inA.placeholder='Вариант A';
  const inB = document.createElement('input'); inB.type='text'; inB.value = it.options[1]||''; inB.placeholder='Вариант B';
  const inC = document.createElement('input'); inC.type='text'; inC.value = it.options[2]||''; inC.placeholder='Вариант C';
  const inD = document.createElement('input'); inD.type='text'; inD.value = it.options[3]||''; inD.placeholder='Вариант D';
  const sel = document.createElement('select'); ['a','b','c','d'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); sel.value = it.correct||'a';

  const tools = document.createElement('div'); tools.className='tools';
  const save = document.createElement('button'); save.className='btn btn-green'; save.textContent='Сохранить';
  const cancel = document.createElement('button'); cancel.className='btn btn-ghost'; cancel.textContent='Отмена';
  tools.appendChild(save); tools.appendChild(cancel);

  ed.appendChild(inQ); ed.appendChild(inA); ed.appendChild(inB); ed.appendChild(inC); ed.appendChild(inD); ed.appendChild(sel); ed.appendChild(tools);

  save.onclick = ()=>{
    const qtxt = inQ.value.trim(); const A=inA.value.trim(), B=inB.value.trim(), C=inC.value.trim(), D=inD.value.trim(); const corr = sel.value;
    if(!qtxt||!A||!B||!C||!D){ showErr('Заполните все поля'); return; }
    const newItem = {question:qtxt, options:[A,B,C,D], correct:corr};
    // обновим на месте
    questionBank[cat][index] = normalizeLoadedQuestion(newItem);
    if(autosave) saveLS();
    renderCats();
    showOk('Вопрос обновлён');
  };
  cancel.onclick = ()=> ed.remove();

  containerElem.appendChild(ed);
}

$('#btnCancelQ').onclick = ()=>{ $('#editor').classList.add('hidden'); editMeta=null; };
$('#btnSaveQ').onclick = ()=>{
  const cat = $('#edCat').value; const q = $('#edQ').value.trim();
  const A=$('#edA').value.trim(), B=$('#edB').value.trim(), C=$('#edC').value.trim(), D=$('#edD').value.trim();
  const corr=$('#edCorrect').value;
  if(!cat||!q||!A||!B||!C||!D){ showErr('Заполните все поля'); return; }
  const item = {question:q, options:[A,B,C,D].map(s=>s.trim()), correct:corr};
  if(!questionBank[cat]) questionBank[cat]=[];
  // редактирование
  if(editMeta){
    const orig = editMeta;
    // если категория не поменялась — обновим на месте
    if(orig.cat === cat){ questionBank[cat][orig.index] = normalizeLoadedQuestion(item); }
    else {
      // удалим из старой
      if(questionBank[orig.cat]) questionBank[orig.cat].splice(orig.index,1);
      questionBank[cat].push(normalizeLoadedQuestion(item));
    }
    editMeta = null;
  } else {
    // защита от дублей
    const exists = (questionBank[cat]||[]).some(x=>x.question===q);
    if(exists){ showErr('Такой вопрос уже есть в этой категории'); return; }
    questionBank[cat].push(normalizeLoadedQuestion(item));
  }
  if(autosave) saveLS();
  renderCats(); $('#editor').classList.add('hidden'); showOk('Вопрос сохранён');
};

// ======= КАТЕГОРИИ =======
$('#btnAddCat').onclick = ()=>{
  const key = ($('#newCatKey').value||'').trim().toLowerCase();
  const name = ($('#newCatName').value||'').trim();
  if(!/^[a-z0-9_]+$/.test(key)){ showErr('Ключ — латиница/цифры/подчёркивание'); return; }
  if(!name){ showErr('Задайте название категории'); return; }
  if(questionBank[key]){ showErr('Такая категория уже существует'); return; }
  questionBank[key]=[]; categoryNames[key]=name; if(autosave) saveLS(); renderCats(); showOk('Категория добавлена');
  $('#newCatKey').value=''; $('#newCatName').value='';
};
$('#btnDelCat').onclick = ()=>{ const k=$('#delCatSel').value; if(!k) return; if(!confirm('Удалить категорию и все вопросы?')) return; delete questionBank[k]; delete categoryNames[k]; if(autosave) saveLS(); renderCats(); };
$('#btnAutosave').onclick = ()=>{ autosave = !autosave; $('#btnAutosave').textContent='Автосохранение: '+(autosave?'вкл':'выкл'); if(autosave) saveLS(); };

// ======= РЕЖИМЫ =======
function setMode(m){
  mode=m;
  if(m==='offline'){ $('#modeBadge').textContent='ОФЛАЙН'; $('#modeNote').textContent='работа из локальной базы и LocalStorage';
    $('#modeOffline').className='btn btn-primary'; $('#modeOnline').className='btn btn-ghost';
  }else{ $('#modeBadge').textContent='ОНЛАЙН'; $('#modeNote').textContent='загрузка из Google Sheets, сохранение через Apps Script';
    $('#modeOffline').className='btn btn-ghost'; $('#modeOnline').className='btn btn-primary';
  }
  saveLS();
}
$('#modeOffline').onclick = ()=>setMode('offline');
$('#modeOnline').onclick = ()=>setMode('online');

// ======= ЗАГРУЗКА ИЗ CSV GOOGLE SHEETS =======
async function loadFromCSV(url){
  if(!url){ showErr('Введите URL CSV Google Sheets'); return; }
  try{
    const r = await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const text = await r.text();
    const rows = parseCSV(text);
    if(rows.length===0){ showErr('CSV пуст или недоступен'); return; }
    const header = rows.shift().map(h => (h||'').toString().trim().toLowerCase());
    const find = names => names.reduce((acc,n)=> acc!==-1?acc: header.indexOf(n), -1);
    const iCat = find(['category','cat','group']);
    const iQ = find(['question','q','text']);
    const ia = find(['a','option_a','opt_a']);
    const ib = find(['b','option_b','opt_b']);
    const ic = find(['c','option_c','opt_c']);
    const id = find(['d','option_d','opt_d']);
    const iCorr = find(['correct','answer','ans','right']);
    if([iCat,iQ,ia,ib,ic,id,iCorr].some(i=>i===-1)){ showErr('В CSV должны быть колонки: category, question, a, b, c, d, correct'); return; }
    // очистим банк
    questionBank={}; categoryNames={};
    rows.forEach(cells=>{
      if(!cells || cells.length===0) return;
      const catRaw = (cells[iCat]||'').toString().trim();
      const cat = (catRaw || 'unsorted').toLowerCase();
      const q = (cells[iQ]||'').toString().trim();
      const A = (cells[ia]||'').toString().trim(); const B = (cells[ib]||'').toString().trim(); const C = (cells[ic]||'').toString().trim(); const D = (cells[id]||'').toString().trim();
      const corr = ((cells[iCorr]||'').toString().trim().toLowerCase()||'a').charAt(0);
      if(!questionBank[cat]){ questionBank[cat]=[]; categoryNames[cat]=cat; }
      if(q){
        const item = {question:q, options:[A,B,C,D].map(normalizeOptionText), correct: ['a','b','c','d'].includes(corr)?corr:'a'};
        if(!questionBank[cat].some(x=>x.question===q)) questionBank[cat].push(item);
      }
    });
    renderCats(); if(autosave) saveLS();
    showOk('Загружено из Google Sheets: категорий '+Object.keys(questionBank).length);
  }catch(e){ showErr('Ошибка загрузки CSV. Проверьте URL и доступ. Детали: '+e.message); }
}
$('#btnLoadRemote').onclick = ()=> loadFromCSV( $('#sheetUrl').value.trim() );

// ======= СОХРАНЕНИЕ ЧЕРЕЗ APPS SCRIPT =======
async function saveViaAppsScript(){
  const url = $('#appsUrl').value.trim();
  if(!url){ showErr('Укажите Apps Script Web App URL'); return; }
  try{
    const payload = { updatedAt: new Date().toISOString(), questionBank, categoryNames };
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.text();
    showOk('Сохранено через Apps Script. Ответ: '+data.slice(0,140));
  }catch(e){ showErr('Ошибка записи через Apps Script. Проверь URL и права (Deploy → Web app → Anyone). ' + e.message); }
}
$('#btnSaveApps').onclick = saveViaAppsScript;

// ======= ИМПОРТ/ЭКСПОРТ =======
$('#btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify({questionBank, categoryNames}, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'questions.json'; a.click();
};
$('#btnImport').onclick = ()=> $('#fileImport').click();
$('#fileImport').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    questionBank = obj.questionBank||{}; categoryNames = obj.categoryNames||{};
    // normalize
    for(const k of Object.keys(questionBank)) questionBank[k] = (questionBank[k]||[]).map(normalizeLoadedQuestion);
    renderCats(); if(autosave) saveLS(); showOk('Импортировано');
  }catch(e){ showErr('Не удалось прочитать JSON: '+e.message); }
});

// ======= ТЕСТ/НАВИГАЦИЯ =======
let deck=[], qi=0, ok=0, bad=0, badMax=3;
function collectSelected(){
  const chosen = [...document.querySelectorAll('.cat-check:checked')].map(i=>i.value);
  let pool=[]; const seen=new Set();
  chosen.forEach(k=> (questionBank[k]||[]).forEach(x=>{ if(!seen.has(x.question)){ seen.add(x.question); pool.push(x); } }));
  return pool;
}
function startQuiz(){
  const pool = collectSelected();
  const desired = parseInt($('#questionCount').value,10)||30;
  badMax = parseInt($('#failureLimit').value,10)||3;
  $('#badMax').textContent = badMax;
  if(pool.length===0){ showErr('Выберите хотя бы одну категорию с вопросами'); return; }
  deck = shuffle(pool.slice());
  if($('#randomOrder').value === '0') deck = pool.slice();
  deck = deck.slice(0, Math.min(desired, deck.length));
  ok=0; bad=0; qi=0; responses = Array(deck.length).fill(null);
  $('#setup').classList.add('hidden'); $('#quiz').classList.remove('hidden'); $('#result').classList.add('hidden');
  renderQuestion();
}
$('#btnStart').onclick = startQuiz;
$('#btnBackToSetup').onclick = ()=>{ $('#quiz').classList.add('hidden'); $('#result').classList.add('hidden'); $('#setup').classList.remove('hidden'); };
$('#btnAgain').onclick = ()=>{ $('#result').classList.add('hidden'); $('#setup').classList.remove('hidden'); };

function renderQuestion(){
  if(qi>=deck.length || bad>=badMax){ return finish(); }
  const q = deck[qi];
  $('#qText').textContent = q.question;
  $('#btnNext').disabled = true;
  const container = $('#optBox'); container.innerHTML='';
  // подготовим варианты
  const corrIndex = ['a','b','c','d'].indexOf(q.correct);
  const opts = (q.options||[]).map((txt,i)=>({text:txt, origIndex:i}));
  shuffle(opts);
  opts.forEach((opt,pos)=>{
    const div=document.createElement('div'); div.className='option';
    // префикс буквы по позиции
    const letter = ['a','b','c','d'][pos];
    div.dataset.correct = (opt.origIndex === corrIndex) ? '1' : '0';
    div.innerHTML = '<strong>'+letter+')</strong> ' + opt.text;
    div.onclick = ()=>{
      // блокируем все варианты
      [...container.querySelectorAll('.option')].forEach(x=>{ x.onclick=null; x.classList.remove('selected'); });
      // пометим выбор
      const isCorrect = div.dataset.correct==='1';
      if(isCorrect){ ok++; div.classList.add('correct'); }
      else { bad++; div.classList.add('incorrect');
        // покажем верный
        [...container.querySelectorAll('.option')].forEach(x=>{ if(x.dataset.correct==='1'){ x.classList.add('correct'); } });
      }
      // сохраним ответ
      responses[qi] = {
        question: q.question,
        options: q.options.slice(),
        selectedText: opt.text,
        selectedIndex: opt.origIndex,
        correctIndex: corrIndex,
        correctText: q.options[corrIndex] || null,
        correct: isCorrect
      };
      $('#btnNext').disabled = false; updateProgress();
    };
    container.appendChild(div);
  });
  updateProgress();
}
$('#btnNext').onclick = ()=>{ qi++; renderQuestion(); };

function updateProgress(){
  $('#okCnt').textContent=ok; $('#badCnt').textContent=bad;
  $('#progressText').textContent=(Math.min(qi+1,deck.length))+'/'+deck.length;
  $('#progressBar').style.width = ((Math.min(qi+1,deck.length)/Math.max(deck.length,1))*100)+'%';
}

function finish(){
  $('#quiz').classList.add('hidden'); $('#result').classList.remove('hidden');
  const score = Math.round((ok/Math.max(deck.length,1))*100);
  $('#resTitle').textContent = score>=80 ? 'Тест успешно пройден!' : 'Тест не пройден';
  $('#resScore').textContent = score+'%'; $('#resOk').textContent=ok; $('#resBad').textContent=bad;
  // подготовим выгрузку неправильных
  window._wrong = (responses||[]).map((r,i)=>{...
